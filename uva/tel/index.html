<!DOCTYPE html>
<meta charset="utf-8">


<meta http-equiv="cache-control" content="max-age=0" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
<meta http-equiv="pragma" content="no-cache" />



<html>

<style>

body {
  font: 10px sans-serif;
}

#display_container {
    width: 1600px;
    height: 600px;
    margin: auto;
}

#overview_display_container, #timeline_display_container {
    float: left;
    width: 50%;
    height: 505px;
    font: 10px sans-serif;
    text-align: center;
}

#overview_display, #timeline_display {
    width: 100%;
    height: 450px;
}

.axis path,
.axis line {
  fill: none;
  stroke: #E6E7E8;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.line {
  fill: none;
  /*fill: url(#pattern);*/
  stroke-width: 1.5px;
}

.legend-box {
  cursor: pointer;  
}

.tick line{
    opacity: 0.4;
  }


</style>

<body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.1/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.7.5/js/bootstrap-select.min.js"></script>

<div id="display_container">
    <div id="overview_display_container">
        <h2 id="overview_header">Overview</h2>
        <select id="source_select" class="selectpicker">
              <option value="g1d1" selected="true">Groep 1 dag 1</option>
              <option value="g1d2">Groep 1 dag 2</option>
              <option value="g2d1">Groep 2 dag 1</option>
              <option value="g2d2">Groep 2 dag 2</option>
        </select>
        <div id="overview_display"></div>
    </div>
    <div id="timeline_display_container">
        <h2>Activity timeline</h2>
        <select id="var_select" class="selectpicker" multiple></select>
        <select id="step_select" class="selectpicker">
              <option value="5_" selected>5 minutes</option>
              <option value="10_">10 minutes</option>
              <option value="15_">15 minutes</option>
        </select>
        <div id="timeline_display"></div>
    </div>
</div>

<script>

grade_books = {};
d3.csv("dashboard_data/grades/g1d1.csv", function(data) {
  grade_books['g1d1'] = {};
  for (var i = 0; i < data.length; i++){
      grade_books['g1d1'][data[i]['student']] = data[i]['grade_normalized'];
  }
});

d3.csv("dashboard_data/grades/g1d2.csv", function(data) {
  grade_books['g1d2'] = {};
  for (var i = 0; i < data.length; i++){
      grade_books['g1d2'][data[i]['student']] = data[i]['grade_normalized'];
  }
});

d3.csv("dashboard_data/grades/g2d1.csv", function(data) {
  grade_books['g2d1'] = {};
  for (var i = 0; i < data.length; i++){
      grade_books['g2d1'][data[i]['student']] = data[i]['grade_normalized'];
  }
});

d3.csv("dashboard_data/grades/g2d2.csv", function(data) {
  grade_books['g2d2'] = {};
  for (var i = 0; i < data.length; i++){
      grade_books['g2d2'][data[i]['student']] = data[i]['grade_normalized'];
  }
});


var selected_student = 999;
var step_size = '5';

var margin = {top: 20, overview_right: 20, bottom: 30, left: 63, timeline_right: 100},
    timeline_width = 760 - margin.left - margin.timeline_right,
    overview_width = 760 - margin.left - margin.overview_right,
    height = 500 - margin.top - margin.bottom;
// Stacked bar overview

var overview_y = d3.scaleBand()
    .rangeRound([height, 0])
    .padding(0.1);

var overview_x = d3.scaleLinear()
    .rangeRound([0, overview_width]);

var color = d3.scaleOrdinal()
    .range(['#2166ac','#67a9cf','#d1e5f0','#fddbc7','#ef8a62','#b2182b']);


var overview_svg = d3.select("#overview_display").append("svg")
    .attr("width", overview_width + margin.left + margin.overview_right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


$("#source_select").change(function(){
    var x = $("#source_select").val();
    var step = $("#step_select").val();
    source = "dashboard_data/"+ step + x +"/";
    overview_svg.selectAll("*").remove();
    if(typeof(timeline_svg) !== 'undefined'){
        timeline_svg.selectAll("*").remove();
    }
    
    document.getElementById("timeline_display_container").style.visibility = 'hidden';      // Hide
    d3.csv(source + "totals.csv", function(d, i, columns) {
      for (i = 1, t = 0; i < columns.length; ++i) t += d[columns[i]] = +d[columns[i]];
      d.total = t;
      return d;
    }, function(error, overview_data) {
      if (error) throw error;
      document.getElementById("overview_header").innerHTML = "Overview";

      console.log("changed source");
      console.log(source);

      var keys = overview_data.columns.slice(1);
      overview_data.sort(function(a, b) { return b.total - a.total; });
      overview_y.domain(overview_data.map(function(d) { return d.leerling; }));
      overview_x.domain([0, d3.max(overview_data, function(d) { return d.total; })]);
      color.domain(keys);



      overview_svg.append("g")
          .attr("class", "axis axis--x")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(overview_x));

      overview_svg.append("g")
          .attr("class", "axis axis--y")
          .call(d3.axisLeft(overview_y))
          .append("text")
          .attr("transform", "rotate(-0)")
          .attr("y", 6)
          .attr("dy", ".71em")
          .style("text-anchor", "end");

      var stack = d3.stack()
          .keys(keys)
          .offset(d3.stackOffsetNone);
      
      var layers= stack(overview_data);

      var layer = overview_svg.selectAll(".layer")
        .data(layers)
        .attr("id", function(d) { return overview_y(d.leerling); })
        .enter().append("g")
        .attr("class", "layer")
        .style("fill", function(d, i) { return color(i); });



      var barMouseOverFunction = function(d, i) {
            if (selected_student != i) {
              d3.selectAll("rect.stack" + i).attr("opacity", 0.5);
            }
          }

      var barMouseOutFunction = function(d, i) {
            if (selected_student != i) {
              d3.selectAll("rect.stack" + i).attr("opacity", 1);
            }
          }

      var barMouseClickFunction = function(d, i) {
            d3.selectAll("rect").attr("opacity", 1);
            d3.selectAll("rect.stack" + i).attr("opacity", 0.3);
            // var x = $("#var_select").val();
            console.log("select student from barMouseClickFunction");
            console.log(overview_data);
            selected_student = i;
            select_student(overview_data[selected_student]);
            console.log(selected_student);
            console.log("Selected above");
            document.getElementById("timeline_display_container").style.visibility = 'visible';     // Show
          }



      layer.selectAll("rect")
        .data(function(d) { return d; })
        .enter().append("rect")
        .attr("y", function(d) { return overview_y(d.data.leerling); })
        .attr("x", function(d) { return overview_x(d[0]); })
        .attr("height", overview_y.bandwidth())
        .attr("width", function(d) { return overview_x(d[1]) - overview_x(d[0]) })
        .attr("class", function(d, i) { return "stack" + i; })
        .style("cursor", "pointer")
        .on("mouseover", barMouseOverFunction)
        .on("mouseout", barMouseOutFunction)
        .on("click", barMouseClickFunction);


      var legend = overview_svg.append("g")
          .attr("font-family", "sans-serif")
          .attr("font-size", 10)
          .attr("text-anchor", "end")
          .selectAll("g")
          .data(keys.slice().reverse())
          .enter().append("g")
          .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

      legend.append("rect")
          .attr("x", overview_width - 19)
          .attr("width", 19)
          .attr("height", 19)
          .attr("fill", color);

      legend.append("text")
          .attr("x", overview_width - 24)
          .attr("y", 9.5)
          .attr("dy", "0.32em")
          .text(function(d) { return d; });

      $("#step_select").change(function(){
          timeline_svg.selectAll("*").remove();
          var x = $("#var_select").val();
          console.log("select student from step_select");
          console.log(overview_data);
          select_student(overview_data[selected_student], x);
      });

      $("#var_select").change(function(){
          timeline_svg.selectAll("*").remove();
          var x = $("#var_select").val();
          console.log("select student from var_select");
          console.log(overview_data);
          select_student(overview_data[selected_student], x);
      });
    });


});

$("#source_select").change();

// Timeline student detail

var bisectDate = d3.bisector(function(d) { return d.date; }).left;
// var parseDate = d3.timeParse("%Y-%m-%d %H:%M:%S");

function parseDate(date) {
  return date.split(" ")[0,1];
}


var timeline_x = d3.scaleBand()
    .rangeRound([0, timeline_width])
    .paddingInner(0.1);

var timeline_x1 = d3.scaleBand()
    .padding(0.05);

var timeline_y = d3.scaleLinear()
    .rangeRound([height, 0]);

var timeline_svg = d3.select("#timeline_display").append("svg")
    .attr("width", timeline_width + margin.left + margin.timeline_right)
    .attr("height", height + margin.top + margin.bottom + 20) //height + margin.top + margin.bottom
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var dropdown_set = false;



function select_student(leerling, variables) {
    d3.select("#timeline_display").selectAll("*").remove();
    var timeline_svg = d3.select("#timeline_display").append("svg")
    .attr("width", timeline_width + margin.left + margin.timeline_right)
    .attr("height", height + margin.top + margin.bottom + 20) //height + margin.top + margin.bottom
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var x = $("#source_select").val();
    var step = $("#step_select").val();
    source = "dashboard_data/"+ step + x +"/";

    var file_name = source + leerling['leerling'] + ".csv";
    console.log("sel");
    console.log(leerling['leerling']);
    console.log(file_name);
    d3.csv(file_name, function(d, i, columns) {
      for (var i = 1, n = columns.length; i < n; ++i) d[columns[i]] = +d[columns[i]];
      return d;
    }, function(error, timeline_data) {
      console.log("timeline data");
      console.log(timeline_data);

      document.getElementById("overview_header").innerHTML = leerling['leerling'] + " grade: " + grade_books[x][leerling['leerling']];



      var keys = timeline_data.columns.slice(1);
      console.log(keys);
      var options = timeline_data.columns.slice(1);

      // First check for what vars data is missing:
      totals = Array.apply(null, Array(keys.length)).map(Number.prototype.valueOf,0);
      for (var i = 0; i < keys.length; i++) {
          for (var j = 0; j < timeline_data.length; j++) {
              totals[i] += timeline_data[j][keys[i]];
          }
      }

      // Remove empty vars
      for (var i = keys.length-1; i >= 0; i--) {
          if (totals[i] == 0) {
              keys.splice(i, 1);
              totals.splice(i, 1);
              options.splice(i, 1);
          }
      }

      if (typeof(variables) !== 'undefined') {
          for (var i = 0; i < keys.length; i++) {
              for (var j = 0; j < timeline_data.length; j++) {
                  if (!variables.includes(keys[i]) || totals[i] == 0) {
                      delete timeline_data[j][keys[i]];
                  }
              }
          }
          keys = variables;
      }

      timeline_data.forEach(function(d) { // Make every date in the csv data correct format
          d.date = parseDate(d.date);
      });

     
      var dropdown = document.getElementById("var_select");
      $("#var_select").empty();
      for(var i = 0; i < options.length; i++) {
          var opt = options[i];
          var el = document.createElement("option");
          el.textContent = opt;
          el.value = opt;
          if (keys.includes(opt)) {
            el.selected = true;
          }
          dropdown.appendChild(el);}
      $('#var_select').selectpicker('refresh');
     
      timeline_x.domain(timeline_data.map(function(d) { return d.date; }));
      timeline_x1.domain(keys).rangeRound([0, timeline_x.bandwidth()]);
      timeline_y.domain([0, d3.max(timeline_data, function(d) { return d3.max(keys, function(key) { return d[key]; }); })]).nice();

      timeline_svg.append("g")
          .selectAll("g")
          .data(timeline_data)
          .enter().append("g")
          .attr("transform", function(d) { return "translate(" + timeline_x(d.date) + ",0)"; })
          .selectAll("rect")
          .data(function(d) { return keys.map(function(key) { return {key: key, value: d[key]}; }); })
          .enter().append("rect")
          .attr("x", function(d) { return timeline_x1(d.key); })
          .attr("y", function(d) { return timeline_y(d.value); })
          .attr("width", timeline_x1.bandwidth())
          .attr("height", function(d) { return height - timeline_y(d.value); })
          .attr("fill", function(d) { return color(d.key); });

      timeline_svg.append("g")
          .attr("class", "axis")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(timeline_x))
          .selectAll("text")
            .attr("y", 0)
            .attr("x", 9)
            .attr("dy", ".35em")
            .attr("transform", "rotate(55)")
            .style("text-anchor", "start");

      timeline_svg.append("g")
          .attr("class", "axis")
          .call(d3.axisLeft(timeline_y).ticks(null, "s"))
        .append("text")
          .attr("x", 2)
          .attr("y", timeline_y(timeline_y.ticks().pop()) + 0.5)
          .attr("dy", "0.32em")
          .attr("fill", "#000")
          .attr("font-weight", "bold")
          .attr("text-anchor", "start");

      var legend = timeline_svg.append("g")
          .attr("font-family", "sans-serif")
          .attr("font-size", 10)
          .attr("text-anchor", "end")
          .selectAll("g")
          .data(keys.slice().reverse())
          .enter().append("g")
          .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

      legend.append("rect")
          .attr("x", timeline_width - 19)
          .attr("width", 19)
          .attr("height", 19)
          .attr("fill", color);

      legend.append("text")
          .attr("x", timeline_width - 24)
          .attr("y", 9.5)
          .attr("dy", "0.32em")
          .text(function(d) { return d; });
    });
}
   
  
  function findMaxY(data){  // Define function "findMaxY"
    var maxYValues = data.map(function(d) { 
      if (d.visible){
        return d3.max(d.values, function(value) { // Return max rating value
          return value.rating; })
      }
    });
    return d3.max(maxYValues);
  }
</script>


</html>
